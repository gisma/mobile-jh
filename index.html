<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DJH – Mobile Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .ctrl-btn {
      background: #fff;
      border: 0;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      box-shadow: 0 1px 6px rgba(0,0,0,.15);
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .legend {
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 1px 10px rgba(0,0,0,.18);
      font: 13px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      max-width: 240px;
    }
    .legend h4 { margin: 0 0 8px 0; font-size: 13px; }
    .legend .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .swatch { width: 12px; height: 12px; border-radius: 999px; border: 2px solid rgba(0,0,0,.15); }

    .howto-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .howto-card {
      width: min(560px, calc(100% - 32px));
      background: #fff;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .howto-card h3 { margin: 0 0 8px 0; font-size: 16px; }
    .howto-card ul { margin: 8px 0 0 18px; padding: 0; }
    .howto-card .actions { display:flex; justify-content:flex-end; margin-top: 12px; }
  </style>
</head>
<body>
<div id="map"></div>

<div id="howto" class="howto-overlay">
  <div class="howto-card">
    <h3>So nutzt du die Karte</h3>
    <ul>
      <li>Die blauen Marker sind Jugendherbergen (geclustert).</li>
      <li>Klick auf eine Jugendherberge lädt die POIs für diese JH (lazy).</li>
      <li>POIs werden farbig nach Kategoriegruppe angezeigt.</li>
      <li>Über das Layer-Menü kannst du JH/POIs ein- und ausblenden.</li>
      <li>„Home“ zoomt wieder auf die Gesamtübersicht.</li>
    </ul>
    <div class="actions">
      <button class="ctrl-btn" id="howtoClose">OK</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(() => {
  const PATH_JH_ONLY = "data/jh_only.geojson";
  const PATH_JH_POI  = (nr) => `data/jh_${nr}.geojson`;

  // --- Farb-Mapping für category_group (stabil, klein gehalten)
  const GROUP_COLORS = {
    "Bildungsinfrastruktur": "#2563eb",
    "Kinder & Jugend":       "#16a34a",
    "Kultur & Geschichte":   "#a855f7",
    "Natur & Landschaft":    "#0ea5e9",
    "Freizeit & Sport":      "#f59e0b",
    "Routen":                "#ef4444",
    "Wissenschaft":          "#8b5cf6",
    "Information":           "#64748b",
    "Sonstiges":             "#334155"
  };

  // --- Minimaler HTML-Sanitizer: wir lassen KML-Description als HTML zu (dein Inhalt),
  //     aber bauen Popups kontrolliert (kein eval, kein Script).
  function safeText(x) {
    if (x === null || x === undefined) return "";
    return String(x);
  }

  // Kategorie aus description extrahieren:
  // erwartet z.B. "<b>Kategorie:</b> Bildungsinfrastruktur — Bibliothek"
  function parseCategoryGroup(descHtml) {
    const s = safeText(descHtml);
    // tolerant: Gedankenstrich kann "—" oder "-" sein
    const m = s.match(/Kategorie:<\/b>\s*([^<]+?)\s*(?:—|-)\s*([^<]+?)\s*(?:<br>|$)/i);
    if (!m) return { group: "Sonstiges", cat: "" };
    return { group: m[1].trim() || "Sonstiges", cat: (m[2] || "").trim() };
  }

  function isJHFeatureFromKmlProps(props) {
    // In jh_<nr>.geojson kommt "Name" aus KML.
    // JH ist bei dir typischerweise "JH <nr> — ..."
    const nm = safeText(props.Name || props.name || "");
    return /^JH\s+\d+\s+—/u.test(nm) || /^JH\s+\d+\s+-/u.test(nm) || /^JH\s+\d+/u.test(nm);
  }

  // --- Map + Basemaps
  const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, attribution: "&copy; OpenStreetMap"
  });

  const esriSat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 19, attribution: "Tiles &copy; Esri" }
  );

  const map = L.map("map", { layers: [osm] });

  // --- Layer: JH cluster + POIs
  const jhCluster = L.markerClusterGroup({
    chunkedLoading: true,
    spiderfyOnMaxZoom: true
  });

  const poiLayer = L.featureGroup();

  // --- Controls: Layers
  const baseMaps = { "OSM": osm, "Satellit": esriSat };
  const overlays = { "Jugendherbergen": jhCluster, "POIs": poiLayer };
  L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(map);

  // --- Home button (Leaflet control)
  let homeBounds = null;
  const HomeControl = L.Control.extend({
    onAdd: function() {
      const btn = L.DomUtil.create("button", "ctrl-btn");
      btn.type = "button";
      btn.textContent = "Home";
      L.DomEvent.disableClickPropagation(btn);
      btn.addEventListener("click", () => {
        if (homeBounds) map.fitBounds(homeBounds.pad(0.10));
      });
      return btn;
    },
    onRemove: function() {}
  });
  (new HomeControl({ position: "topleft" })).addTo(map);

  // --- Howto button
  const HowtoControl = L.Control.extend({
    onAdd: function() {
      const btn = L.DomUtil.create("button", "ctrl-btn");
      btn.type = "button";
      btn.textContent = "How-to";
      L.DomEvent.disableClickPropagation(btn);
      btn.addEventListener("click", () => showHowto(true));
      return btn;
    }
  });
  (new HowtoControl({ position: "topleft" })).addTo(map);

  const howto = document.getElementById("howto");
  document.getElementById("howtoClose").addEventListener("click", () => showHowto(false));
  howto.addEventListener("click", (e) => { if (e.target === howto) showHowto(false); });
  function showHowto(on) { howto.style.display = on ? "flex" : "none"; }

  // --- Legend control (toggle)
  let legendVisible = true;

  const legendCtrl = L.control({ position: "bottomleft" });
  legendCtrl.onAdd = function() {
    const div = L.DomUtil.create("div", "legend");
    div.id = "legendBox";
    div.innerHTML = renderLegendHtml();
    L.DomEvent.disableClickPropagation(div);
    return div;
  };
  legendCtrl.addTo(map);

  const LegendToggle = L.Control.extend({
    onAdd: function() {
      const btn = L.DomUtil.create("button", "ctrl-btn");
      btn.type = "button";
      btn.textContent = "Legende";
      L.DomEvent.disableClickPropagation(btn);
      btn.addEventListener("click", () => {
        legendVisible = !legendVisible;
        const box = document.getElementById("legendBox");
        if (box) box.style.display = legendVisible ? "block" : "none";
      });
      return btn;
    }
  });
  (new LegendToggle({ position: "bottomleft" })).addTo(map);

  function renderLegendHtml() {
    const groups = Object.keys(GROUP_COLORS);
    const rows = groups.map(g => {
      const c = GROUP_COLORS[g];
      return `<div class="row"><span class="swatch" style="background:${c}"></span><span>${g}</span></div>`;
    }).join("");
    return `<h4>POI-Kategorien</h4>${rows}`;
  }

  // --- Lazy load cache (pro JH)
  const loadedPoi = new Map(); // nr -> true

  async function loadJhOnly() {
    const r = await fetch(PATH_JH_ONLY, { cache: "no-store" });
    if (!r.ok) throw new Error(`Konnte ${PATH_JH_ONLY} nicht laden (${r.status}).`);
    return r.json();
  }

  function jhMarkerPopup(props) {
    const nr  = safeText(props.nr);
    const nm  = safeText(props.jh_name || props.name || props.Name || "");
    const ort = safeText(props.ort || props.city || "");
    const title = nm ? nm : (nr ? `JH ${nr}` : "Jugendherberge");
    const lines = [
      `<b>${title}</b>`,
      nr ? `<div>Nr: ${nr}</div>` : "",
      ort ? `<div>Ort: ${ort}</div>` : "",
      nr ? `<div style="margin-top:6px;opacity:.8">Klick lädt POIs (lazy).</div>` : ""
    ].filter(Boolean).join("");
    return lines;
  }

  async function loadPoisForNr(nr) {
    if (!nr) return;

    // wenn bereits geladen: nur highlight / reopen wäre möglich, wir laden nicht neu
    if (loadedPoi.get(String(nr))) return;

    const url = PATH_JH_POI(nr);
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`Konnte ${url} nicht laden (${r.status}).`);

    const gj = await r.json();

    // GeoJSON enthält JH + POIs; wir nehmen hier NUR POIs (alles, was nicht wie JH-Name aussieht)
    const poiFeatures = (gj.features || []).filter(f => {
      const props = f.properties || {};
      return !isJHFeatureFromKmlProps(props);
    });

    const poiGJ = { type: "FeatureCollection", features: poiFeatures };

    const layer = L.geoJSON(poiGJ, {
      pointToLayer: (feature, latlng) => {
        const props = feature.properties || {};
        const desc  = props.description || props.Description || "";
        const parsed = parseCategoryGroup(desc);
        const group = parsed.group in GROUP_COLORS ? parsed.group : "Sonstiges";
        const color = GROUP_COLORS[group] || GROUP_COLORS["Sonstiges"];

        return L.circleMarker(latlng, {
          radius: 6,
          weight: 2,
          color: "rgba(255,255,255,.9)",
          fillColor: color,
          fillOpacity: 0.9
        });
      },
      onEachFeature: (feature, lyr) => {
        const props = feature.properties || {};
        const nm = safeText(props.Name || props.name || "POI");
        const desc = props.description || props.Description || "";
        // Popup: Name + raw description (dein HTML)
        lyr.bindPopup(`<b>${nm}</b><div style="margin-top:6px">${desc}</div>`, { maxWidth: 360 });
      }
    });

    layer.addTo(poiLayer);
    loadedPoi.set(String(nr), true);
  }

  function addJhMarkers(gj) {
    const jh = L.geoJSON(gj, {
      pointToLayer: (feature, latlng) => {
        return L.marker(latlng);
      },
      onEachFeature: (feature, lyr) => {
        const props = feature.properties || {};
        const nr = props.nr;
        lyr.bindPopup(jhMarkerPopup(props));

        lyr.on("click", async () => {
          try {
            await loadPoisForNr(nr);
          } catch (e) {
            alert(e.message || String(e));
          }
        });
      }
    });

    jhCluster.addLayer(jh);
    map.addLayer(jhCluster);

    const b = jhCluster.getBounds();
    if (b && b.isValid()) {
      homeBounds = b;
      map.fitBounds(b.pad(0.10));
    } else {
      map.setView([51.2, 10.4], 6); // Fallback Deutschland
    }
  }

  // --- Boot
  (async () => {
    try {
      const gj = await loadJhOnly();
      addJhMarkers(gj);
      // Hinweis beim ersten Start einmal anzeigen
      showHowto(true);
    } catch (e) {
      alert(e.message || String(e));
    }
  })();

})();
</script>
</body>
</html>
