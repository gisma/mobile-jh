<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DJH – Mobile Karte</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .ctrlbox {
      position: absolute; z-index: 1000;
      top: 12px; left: 12px;
      background: rgba(255,255,255,0.92);
      border-radius: 10px;
      box-shadow: 0 3px 18px rgba(0,0,0,0.2);
      padding: 10px 12px;
      max-width: 360px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.25;
    }
    .ctrlbox h3 { margin: 0 0 6px 0; font-size: 14px; }
    .ctrlbox p { margin: 6px 0; }
    .ctrlbox .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .btn {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn:active { transform: translateY(1px); }

    .status {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(0,0,0,0.06);
      font-size: 12px;
      word-break: break-word;
    }

    .legend {
      position: absolute; z-index: 1000;
      bottom: 18px; left: 12px;
      background: rgba(255,255,255,0.92);
      border-radius: 10px;
      box-shadow: 0 3px 18px rgba(0,0,0,0.2);
      padding: 10px 12px;
      max-width: 360px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size: 13px;
    }
    .legend h3 { margin: 0 0 8px 0; font-size: 14px; }
    .legend .item { display:flex; align-items:center; gap:8px; margin: 4px 0; }
    .swatch { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.25); }
    .muted { color:#666; }
    .hidden { display:none; }

    .leaflet-popup-content { margin: 10px 12px; }
    .popup-title { font-weight: 700; margin-bottom: 6px; }
    .popup-small { font-size: 12px; color: #555; margin-top: 6px; }
    .popup-btn {
      display:inline-block;
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    /* farbige JH-Marker (DivIcon) */
    .jh-dot {
      width: 14px; height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 1px 5px rgba(0,0,0,0.35);
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="ctrlbox" id="howto">
  <h3>DJH-Karte</h3>

  <!-- Default: eingeklappt -->
  <div id="howtoBody" class="hidden">
    <p>Übersicht aller Jugendherbergen. POIs werden pro JH erst beim Klick nachgeladen.</p>
    <p class="muted">Mehr Details: <a href="README.md" target="_blank" rel="noopener">README.md</a></p>
  </div>

  <div class="row">
    <button class="btn" id="btnLegend">Legende</button>
    <button class="btn" id="btnHowto">How-to an</button>
    <button class="btn" id="btnHome">Home</button>
  </div>

  <div class="status" id="status">Lade Jugendherbergen…</div>
</div>

<!-- Default: Legende sichtbar -->
<div class="legend" id="legend">
  <h3>Farben</h3>
  <div class="muted" style="margin:0 0 6px 0;">JH-Farbe = häufigste POI-Kategorie (aus <code>manifest.json</code>). POI-Farbe = <code>category_group</code>.</div>
  <div id="legendItems"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  // ---------- Config ----------
  const PATH_JH_ONLY   = "data/geojson/DJH_alle_JH.geojson";        // Jugendherbergen (Punkte)
  const PATH_MANIFEST  = "data/geojson/manifest.json";          // Mapping nr -> dominante Kategorie (für JH-Farbe)
  const PATH_POI       = (nr) => `data/geojson/jh_${nr}.geojson`; // POIs pro JH (lazy)

  // Farben für category_group (POIs) und dominante Kategorie (JH)
  const COLOR_BY_GROUP = {
    "Bildungsinfrastruktur": "#1f77b4",
    "Kinder & Jugend":       "#2ca02c",
    "Kultur & Geschichte":   "#d62728",
    "Natur & Landschaft":    "#9467bd",
    "Freizeit & Sport":      "#ff7f0e",
    "Routen":                "#8c564b",
    "Wissenschaft":          "#17becf",
    "Information":           "#7f7f7f",
    "Unbekannt":             "#333333"
  };

  // ---------- UI helpers ----------
  function normalizeNr(x) {
  if (x === null || x === undefined) return null;
  const m = String(x).match(/\d+/);
  return m ? m[0] : null;
}

function extractNrFromFilename(s) {
  if (!s) return null;
  // akzeptiert z.B. data/geojson/jh_520.geojson, jh_520.geojson, JH_520_master.kmz, etc.
  const m = String(s).match(/(?:^|[^0-9])(?:jh|JH)[\-_ ]*([0-9]+)(?:[^0-9]|$)/) ||
            String(s).match(/(?:^|[^0-9])([0-9]{1,6})(?:[^0-9]|$)/);
  return m ? m[1] : null;
}

function pickDominantFromObj(o) {
  if (!o || typeof o !== "object") return null;
  return (
    o.dominant_group ??
    o.dominant ??
    o.dominantCategoryGroup ??
    o.dominant_category_group ??
    o.top_group ??
    o.main_group ??
    null
  );
}

// Baut einen Index: nr(string) -> { dominant_group, counts, ... }
// Baut einen Index: nr(string) -> { dominant_group, counts, raw }
function buildManifestIndex(manifest) {
  const idx = new Map();
  if (!manifest) return idx;

  // 1) Falls manifest ein Array ist oder bekannte Array-Container hat
  const candidates =
    Array.isArray(manifest) ? manifest :
    Array.isArray(manifest?.items) ? manifest.items :
    Array.isArray(manifest?.files) ? manifest.files :
    Array.isArray(manifest?.features) ? manifest.features :
    null;

  if (candidates) {
    for (const it of candidates) {
      const obj = it?.properties ? it.properties : it;

      const nr =
        normalizeNr(obj?.nr) ||
        normalizeNr(obj?.Nr) ||
        normalizeNr(obj?.NR) ||
        normalizeNr(obj?.jh_nr) ||
        normalizeNr(obj?.id) ||
        extractNrFromFilename(obj?.file) ||
        extractNrFromFilename(obj?.path) ||
        extractNrFromFilename(obj?.href) ||
        extractNrFromFilename(obj?.name);

      if (!nr) continue;

      const dom = pickDominantFromObj(obj);
      const counts = obj?.counts ?? obj?.group_counts ?? obj?.category_group_counts ?? null;

      idx.set(String(nr), { dominant_group: dom, counts, raw: obj });
    }
    return idx;
  }

  // 2) Falls manifest.jh / manifest.index / manifest.by_nr existiert (Objekt-mapping)
  if (manifest && typeof manifest === "object") {
    const jhObj = manifest.jh || manifest.index || manifest.by_nr || null;
    if (jhObj && typeof jhObj === "object") {
      for (const [k, v] of Object.entries(jhObj)) {
        const nr = normalizeNr(k);
        if (!nr) continue;
        const dom = pickDominantFromObj(v);
        const counts = v?.counts ?? v?.group_counts ?? null;
        idx.set(String(nr), { dominant_group: dom, counts, raw: v });
      }
      return idx;
    }
  }

  // 3) WICHTIG: dein aktuelles Format (Plain Object):
  // { "298": { dominant_group: "...", dominant_count: ..., poi_total: ... }, ... }
  if (manifest && typeof manifest === "object") {
    for (const [k, v] of Object.entries(manifest)) {
      const nr = normalizeNr(k);
      if (!nr) continue;

      // v kann Objekt oder (seltener) String sein
      const dom = (typeof v === "string") ? v : pickDominantFromObj(v);
      const counts = v?.counts ?? v?.group_counts ?? null;

      idx.set(String(nr), { dominant_group: dom, counts, raw: v });
    }
  }

  return idx;
}



  
  
  const elStatus = document.getElementById("status");
  const elLegend = document.getElementById("legend");
  const elLegendItems = document.getElementById("legendItems");
  const elHowtoBody = document.getElementById("howtoBody");

  function setStatus(msg) { elStatus.textContent = msg; }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function getNrFromProps(p) {
    const v = p?.nr ?? p?.Nr ?? p?.NR ?? p?.jh_nr ?? p?.JH_NR ?? p?.id ?? null;
    if (v === null || v === undefined) return null;
    const m = String(v).match(/\d+/);
    return m ? m[0] : null;
  }

  function getNameFromProps(p) {
    return p?.jh_name ?? p?.name ?? p?.Name ?? p?.title ?? "Jugendherberge";
  }

  function getOrtFromProps(p) {
    return p?.ort ?? p?.Ort ?? p?.city ?? p?.addr_city ?? "";
  }

  function getDescFromProps(p) {
    return p?.Description ?? p?.description ?? p?.desc ?? "";
  }

  function getGroupFromProps(p) {
    return p?.category_group ?? p?.categoryGroup ?? p?.group ?? p?.layer ?? "Unbekannt";
  }

  function colorForGroup(g) {
    return COLOR_BY_GROUP[g] || COLOR_BY_GROUP["Unbekannt"];
  }

  function buildLegend() {
    const order = [
      "Bildungsinfrastruktur","Kinder & Jugend","Kultur & Geschichte","Natur & Landschaft",
      "Freizeit & Sport","Routen","Wissenschaft","Information","Unbekannt"
    ];
    elLegendItems.innerHTML = "";
    for (const g of order) {
      const row = document.createElement("div");
      row.className = "item";
      const sw = document.createElement("div");
      sw.className = "swatch";
      sw.style.background = colorForGroup(g);
      const tx = document.createElement("div");
      tx.textContent = g;
      row.appendChild(sw);
      row.appendChild(tx);
      elLegendItems.appendChild(row);
    }
  }
  buildLegend();

  // ---------- Map + basemaps ----------
  const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, attribution: "&copy; OpenStreetMap"
  });

  const sat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 19, attribution: "Tiles &copy; Esri" }
  );

  // FIX #2: Satellit ist default aktiv
  const map = L.map("map", { layers: [sat] });

  

const jhCluster = L.markerClusterGroup({
  chunkedLoading: true,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: false,
  spiderfyOnMaxZoom: true,

  // 1) weniger aggressiv:
  maxClusterRadius: 80,          // Default ~80. 20–35 ist „deutlich weniger Cluster“.

  // 2) ab bestimmtem Zoom keine Cluster mehr:
  disableClusteringAtZoom: 7     // ab Zoom 7 werden alle Marker einzeln gezeigt
});
  const poiLayer = L.layerGroup();
  L.control.layers(
    { "Satellit": sat, "OSM": osm },
    { "Jugendherbergen": jhCluster, "POIs (geladen)": poiLayer },
    { collapsed: true }
  ).addTo(map);

  // ---------- State ----------
  let homeBounds = null;
  const poiCache = new Map(); // nr -> FeatureCollection
  let manifest = null;        // geladenes Manifest
  let manifestIndex = null;   // nr -> dominante Kategorie (string)

  async function fetchJson(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status} für ${url}`);
    return await r.json();
  }

function dominantGroupForNr(nr) {
  const key = normalizeNr(nr);
  if (!key) return "Unbekannt";
  if (!manifestIndex || !(manifestIndex instanceof Map)) return "Unbekannt";

  const rec = manifestIndex.get(String(key));
  if (!rec) return "Unbekannt";

  // rec ist (nach buildManifestIndex) ein Objekt { dominant_group, ... }
  const dom = rec?.dominant_group;

  if (dom && String(dom).trim() !== "") return String(dom);
  return "Unbekannt";
}

  function jhIconForNr(nr) {
    const g = dominantGroupForNr(nr);
    const c = colorForGroup(g);
    return L.divIcon({
      className: "",
      html: `<div class="jh-dot" style="background:${c}"></div>`,
      iconSize: [14,14],
      iconAnchor: [7,7],
      popupAnchor: [0,-8]
    });
  }

  async function loadPOIsForJH(nr) {
    if (!nr) throw new Error("Keine JH-Nr");
    if (poiCache.has(nr)) return poiCache.get(nr);

    const url = PATH_POI(nr);
    setStatus(`Lade POIs: JH ${nr} …`);
    const gj = await fetchJson(url);

    if (!gj || gj.type !== "FeatureCollection" || !Array.isArray(gj.features)) {
      throw new Error(`Unerwartetes GeoJSON-Format: ${url}`);
    }

    poiCache.set(nr, gj);
    return gj;
  }

  function poiToLayer(feature, latlng) {
    const p = feature?.properties || {};
    const group = getGroupFromProps(p);
    const c = colorForGroup(group);

    return L.circleMarker(latlng, {
      radius: 6,
      color: c,
      weight: 2,
      fillColor: c,
      fillOpacity: 0.85
    });
  }

  function poiPopupHtml(p) {
    const name  = escapeHtml(p?.poi_name ?? p?.name ?? p?.Name ?? "POI");
    const group = escapeHtml(getGroupFromProps(p));
    const desc  = getDescFromProps(p);

    return `
      <div class="popup-title">${name}</div>
      <div><b>Kategorie:</b> ${group}</div>
      ${desc ? `<div style="margin-top:6px">${desc}</div>` : `<div class="popup-small">Keine Zusatzinfos.</div>`}
    `;
  }

  async function init() {
    try {
      // Manifest ist optional, aber wenn vorhanden: JH-Marker einfärben
      try {
        manifest = await fetchJson(PATH_MANIFEST);
        manifestIndex = buildManifestIndex(manifest);
      } catch (e) {
        console.warn("manifest konnte nicht geladen werden:", e);
        manifestIndex = null;
      }

      const gj = await fetchJson(PATH_JH_ONLY);

      // Home bounds
      const tmp = L.geoJSON(gj);
      homeBounds = tmp.getBounds();
      if (homeBounds && homeBounds.isValid()) map.fitBounds(homeBounds.pad(0.05));

      // JH Layer
      const jhLayer = L.geoJSON(gj, {
        pointToLayer: (feature, latlng) => {
          const p = feature?.properties || {};
          const nr = getNrFromProps(p);
          return L.marker(latlng, {
            title: getNameFromProps(p),
            icon: jhIconForNr(nr)
          });
        },
        onEachFeature: (feature, layer) => {
          const p   = feature?.properties || {};
          const nr  = getNrFromProps(p);
          const nm  = getNameFromProps(p);
          const ort = getOrtFromProps(p);
          const plz = p?.plz ?? "";
const str = p?.strasse ?? "";
const tel = p?.telefon ?? "";
const adr = p?.address ?? "";
const bl  = p?.bundesland ?? "";


          const dom = dominantGroupForNr(nr);

const html = `
  <div class="popup-title">${escapeHtml(nm ?? "—")}</div>

  <div><b>Nr:</b> ${escapeHtml(nr ?? "—")}</div>

  ${ort ? `<div><b>Ort:</b> ${escapeHtml(ort)}</div>` : ""}

  ${p?.plz ? `<div><b>PLZ:</b> ${escapeHtml(p.plz)}</div>` : ""}

  ${p?.strasse ? `<div><b>Straße:</b> ${escapeHtml(p.strasse)}</div>` : ""}

  ${p?.address ? `<div><b>Adresse:</b> ${escapeHtml(p.address)}</div>` : ""}

  ${p?.bundesland ? `<div><b>Bundesland:</b> ${escapeHtml(p.bundesland)}</div>` : ""}

  ${p?.telefon ? `<div><b>Telefon:</b> ${escapeHtml(p.telefon)}</div>` : ""}

  ${dom ? `<div><b>Dominant:</b> ${escapeHtml(dom)}</div>` : ""}

  ${p?.["name.x"] ? `<div><b>name.x:</b> ${escapeHtml(p["name.x"])}</div>` : ""}

  <div class="popup-small">Klick lädt POIs (lazy).</div>

  <div>
    <button class="popup-btn" data-nr="${escapeHtml(nr ?? "")}">
      POIs laden
    </button>
  </div>
`;
          layer.bindPopup(html);

          layer.on("click", async () => {
            if (!nr) {
              setStatus("Fehler: JH hat keine Nr (nr fehlt im DJH_alle_JH.geojson).");
              return;
            }
            try {
              const gjPois = await loadPOIsForJH(nr);

              poiLayer.clearLayers();

              const poiGeo = L.geoJSON(gjPois, {
                pointToLayer: poiToLayer,
                onEachFeature: (f, l) => l.bindPopup(poiPopupHtml(f?.properties || {})),
                filter: (f) => {
                  const t = f?.geometry?.type;
                  return t === "Point" || t === "MultiPoint";
                }
              });

              poiGeo.addTo(poiLayer);
              if (!map.hasLayer(poiLayer)) map.addLayer(poiLayer);

              setStatus(`POIs geladen: JH ${nr} (${gjPois.features.length} Features)`);
            } catch (e) {
              console.error(e);
              setStatus(`Fehler beim Laden der POIs für JH ${nr}: ${e.message}`);
              alert(`Konnte POIs für JH ${nr} nicht laden.\n${e.message}`);
            }
          });

          layer.on("popupopen", (ev) => {
            const btn = ev.popup.getElement()?.querySelector("button.popup-btn");
            if (!btn) return;
            btn.addEventListener("click", () => layer.fire("click"), { once: true });
          });
        }
      });

      jhCluster.addLayer(jhLayer);
      map.addLayer(jhCluster);

      // Default: Legende sichtbar (ist sie per HTML), Status ok
      setStatus("Bereit. Klicke eine Jugendherberge an.");
    } catch (e) {
      console.error(e);
      setStatus(`Fehler: ${e.message}`);
      alert(`Konnte ${PATH_JH_ONLY} nicht laden.\n${e.message}`);
    }
  }

  // ---------- Buttons ----------
  document.getElementById("btnLegend").addEventListener("click", () => {
    elLegend.classList.toggle("hidden");
  });

  document.getElementById("btnHowto").addEventListener("click", (ev) => {
    const btn = ev.currentTarget;
    const hidden = elHowtoBody.classList.toggle("hidden");
    btn.textContent = hidden ? "How-to an" : "How-to aus";
  });

  document.getElementById("btnHome").addEventListener("click", () => {
    if (homeBounds && homeBounds.isValid()) map.fitBounds(homeBounds.pad(0.05));
  });

  init();
</script>
</body>
</html>
