<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DJH – Jugendherbergen & POIs</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      max-width: min(360px, calc(100vw - 20px));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 13px;
      line-height: 1.25rem;
    }
    .panel h1 {
      font-size: 14px;
      margin: 0 0 6px 0;
    }
    .panel .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .btn {
      border: 1px solid #ddd;
      background: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn:hover { background: #f6f6f6; }
    .muted { color: #666; }

    .legend {
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 12px;
      line-height: 18px;
    }
    .legend .item { display: flex; align-items: center; gap: 8px; margin: 3px 0; }
    .swatch {
      width: 12px; height: 12px; border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.2);
      flex: 0 0 12px;
    }

    /* small mobile tweak */
    @media (max-width: 480px) {
      .panel { top: 8px; left: 8px; padding: 9px 10px; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel" id="howto">
    <h1>DJH Karte</h1>
    <div class="muted" style="margin-bottom:6px;">
      Klick auf eine Jugendherberge lädt POIs nach. Zoom ins Cluster zeigt Details.
    </div>
    <div class="row">
      <button class="btn" id="btnHome">Home</button>
      <button class="btn" id="btnLegend">Legende</button>
      <button class="btn" id="btnHelp">How-to</button>
    </div>
    <div class="muted" style="margin-top:6px;">
      Status: <span id="status">lade…</span>
    </div>
  </div>

  <script>
    // ---------- Config ----------
    const DATA_DIR = "data";
    const JH_ONLY = `${DATA_DIR}/jh_only.geojson`;

    // POI Farben nach category_group
    const colors = {
      "Bildungsinfrastruktur": "#1f78b4",
      "Kinder & Jugend": "#33a02c",
      "Kultur & Geschichte": "#e31a1c",
      "Natur & Landschaft": "#6a3d9a",
      "Freizeit & Sport": "#ff7f00",
      "Wissenschaft": "#b15928",
      "Information": "#17becf",
      "Routen": "#8c564b"
    };
    const fallbackColor = "#666";

    const statusEl = document.getElementById("status");
    function setStatus(s) { statusEl.textContent = s; }

    // ---------- Basemaps ----------
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    });

    // Esri World Imagery (leicht & robust)
    const esriSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, attribution: "Tiles &copy; Esri" }
    );

    // ---------- Map ----------
    const map = L.map("map", {
      layers: [osm],
      zoomControl: true
    });

    // Default view (wird nach JH-Ladung auf bounds gesetzt)
    map.setView([51.0, 10.0], 6);

    // ---------- Layer groups ----------
    const jhClusters = L.markerClusterGroup({
      showCoverageOnHover: false,
      spiderfyOnMaxZoom: true,
      disableClusteringAtZoom: 12
    });
    const poiLayer = L.layerGroup();

    // Layer control
    const baseLayers = { "OSM": osm, "Satellit": esriSat };
    const overlays = { "Jugendherbergen": jhClusters, "POIs": poiLayer };
    L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

    // ---------- Legend control ----------
    let legendVisible = true;
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function() {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div style="font-weight:600; margin-bottom:6px;">Kategorien</div>
        ${Object.keys(colors).map(k => `
          <div class="item">
            <span class="swatch" style="background:${colors[k]};"></span>
            <span>${k}</span>
          </div>
        `).join("")}
        <div class="item">
          <span class="swatch" style="background:${fallbackColor};"></span>
          <span>Sonstiges</span>
        </div>
      `;
      // Clicks auf Legende sollen nicht die Karte bewegen
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    legend.addTo(map);

    function toggleLegend() {
      legendVisible = !legendVisible;
      if (legendVisible) legend.addTo(map);
      else legend.remove();
    }

    // ---------- Helpers ----------
    function htmlEscape(s) {
      if (s === null || s === undefined) return "";
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function poiStyle(feature) {
      const p = feature.properties || {};
      const cg = p.category_group || p.category || "";
      const c = colors[cg] || fallbackColor;
      return {
        radius: 6,
        fillColor: c,
        color: "#fff",
        weight: 1,
        fillOpacity: 0.92
      };
    }

    function poiPopupHTML(p) {
      const title = htmlEscape(p.name || p.poi_name || "POI");
      const cg = htmlEscape(p.category_group || "");
      const cat = htmlEscape(p.category || "");
      const dist = (p.dist_m !== undefined && p.dist_m !== null) ? `${htmlEscape(p.dist_m)} m` : "";
      const ort = htmlEscape(p.ort || "");
      const descr = p.Description ? String(p.Description) : ""; // ggf. schon HTML aus Export

      // Falls Description HTML ist, lassen wir es drin; sonst fallback
      const meta = `
        ${cg ? `<div><b>${cg}</b>${cat ? ` — ${cat}` : ""}</div>` : ""}
        ${dist ? `<div><b>Distanz:</b> ${dist}</div>` : ""}
        ${ort ? `<div><b>Ort:</b> ${ort}</div>` : ""}
      `;
      return `<div style="min-width:220px">
        <div style="font-weight:600; margin-bottom:4px">${title}</div>
        ${descr ? `<div style="margin-bottom:6px">${descr}</div>` : meta}
      </div>`;
    }

    // ---------- Data loading ----------
    const poiCache = new Map(); // nr -> L.GeoJSON layer

    async function loadGeoJSON(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status} für ${url}`);
      return await r.json();
    }

    function getNrFromProps(props) {
      // robust: nr kann Zahl oder String sein
      const nr = props?.nr ?? props?.NR ?? props?.jh_nr ?? props?.JH_NR;
      if (nr === null || nr === undefined) return null;
      const m = String(nr).match(/\d+/);
      return m ? m[0] : null;
    }

    async function loadPOIsForJH(nr) {
      if (poiCache.has(nr)) {
        return poiCache.get(nr);
      }
      const url = `${DATA_DIR}/jh_${nr}.geojson`;
      setStatus(`lade POIs für JH ${nr}…`);
      const data = await loadGeoJSON(url);

      // GeoJSON kann JH+POI enthalten -> wir rendern:
      // - Punkte mit kind="JH" als Marker (optional)
      // - kind="POI" als circleMarker
      // Wenn "kind" nicht existiert: POIs erkennen über category_group/poi_name/name, JH über nr
      const layer = L.geoJSON(data, {
        pointToLayer: (feature, latlng) => {
          const p = feature.properties || {};
          const kind = (p.kind || "").toUpperCase();

          const isJH = (kind === "JH") || (
            (p.category_group === undefined && p.category === undefined) &&
            (getNrFromProps(p) !== null)
          );

          if (isJH) {
            // JH Marker: neutral dunkel
            return L.circleMarker(latlng, {
              radius: 7,
              fillColor: "#111",
              color: "#fff",
              weight: 2,
              fillOpacity: 0.9
            });
          }

          // POI
          return L.circleMarker(latlng, poiStyle(feature));
        },
        onEachFeature: (feature, lyr) => {
          const p = feature.properties || {};
          lyr.bindPopup(poiPopupHTML(p));
        },
        filter: (feature) => {
          // Filter: keine leeren Namen als POI anzeigen
          const p = feature.properties || {};
          const kind = (p.kind || "").toUpperCase();
          const isJH = (kind === "JH") || (getNrFromProps(p) !== null && !p.category_group && !p.category);

          if (isJH) return true;

          const name = (p.name || p.poi_name || "").trim();
          if (!name) return false; // das war dein Hauptproblem in MyMaps: "Unbenannt"
          // category_group kann fehlen -> trotzdem zeigen wir POI, aber in fallbackColor
          return true;
        }
      });

      poiCache.set(nr, layer);
      return layer;
    }

    // ---------- JH rendering ----------
    let homeBounds = null;

    async function init() {
      try {
        setStatus("lade Jugendherbergen…");
        const jhData = await loadGeoJSON(JH_ONLY);

        const jhLayer = L.geoJSON(jhData, {
          pointToLayer: (feature, latlng) => {
            // JH Marker: dunkler Punkt (mobil unaufdringlich) – Cluster macht Rest
            return L.circleMarker(latlng, {
              radius: 7,
              fillColor: "#111",
              color: "#fff",
              weight: 2,
              fillOpacity: 0.9
            });
          },
          onEachFeature: (feature, lyr) => {
            const p = feature.properties || {};
            const nr = getNrFromProps(p);
            const name = htmlEscape(p.name || p.jh_name || "Jugendherberge");
            const ort = htmlEscape(p.ort || "");
            const title = nr ? `JH ${nr} — ${name}` : name;

            lyr.bindPopup(`
              <div style="min-width:240px">
                <div style="font-weight:600; margin-bottom:6px">${title}</div>
                ${ort ? `<div><b>Ort:</b> ${ort}</div>` : ""}
                <div class="muted" style="margin-top:6px">Klick lädt POIs dieser JH nach.</div>
              </div>
            `);

            lyr.on("click", async () => {
              if (!nr) return;
              try {
                const layer = await loadPOIsForJH(nr);
                if (!map.hasLayer(poiLayer)) map.addLayer(poiLayer);
                layer.addTo(poiLayer);
                setStatus(`POIs geladen: JH ${nr}`);
              } catch (e) {
                console.error(e);
                setStatus(`POIs konnten nicht geladen werden (JH ${nr}).`);
                alert(`Konnte data/jh_${nr}.geojson nicht laden.`);
              }
            });
          }
        });

        jhClusters.addLayer(jhLayer);
        map.addLayer(jhClusters);

        // Home bounds
        const b = jhLayer.getBounds();
        if (b && b.isValid()) {
          homeBounds = b.pad(0.15);
          map.fitBounds(homeBounds, { animate: false });
        }

        setStatus("bereit");
      } catch (e) {
        console.error(e);
        setStatus("Fehler beim Laden.");
        alert("Konnte jh_only.geojson nicht laden.");
      }
    }

    // ---------- UI buttons ----------
    document.getElementById("btnLegend").addEventListener("click", toggleLegend);

    let howtoVisible = true;
    document.getElementById("btnHelp").addEventListener("click", () => {
      howtoVisible = !howtoVisible;
      document.getElementById("howto").style.display = howtoVisible ? "block" : "none";
    });

    document.getElementById("btnHome").addEventListener("click", () => {
      if (homeBounds) map.fitBounds(homeBounds, { animate: true });
      else map.setView([51.0, 10.0], 6);
    });

    init();
  </script>
</body>
</html>
