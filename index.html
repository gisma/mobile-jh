<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DJH – Mobile Karte</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .ctrlbox {
      position: absolute; z-index: 1000;
      top: 12px; left: 12px;
      background: rgba(255,255,255,0.92);
      border-radius: 10px;
      box-shadow: 0 3px 18px rgba(0,0,0,0.2);
      padding: 10px 12px;
      max-width: 320px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.25;
    }
    .ctrlbox h3 { margin: 0 0 6px 0; font-size: 14px; }
    .ctrlbox p { margin: 6px 0; }
    .ctrlbox .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .btn {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn:active { transform: translateY(1px); }

    .status {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(0,0,0,0.06);
      font-size: 12px;
      word-break: break-word;
    }

    .legend {
      position: absolute; z-index: 1000;
      bottom: 18px; left: 12px;
      background: rgba(255,255,255,0.92);
      border-radius: 10px;
      box-shadow: 0 3px 18px rgba(0,0,0,0.2);
      padding: 10px 12px;
      max-width: 320px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size: 13px;
    }
    .legend h3 { margin: 0 0 8px 0; font-size: 14px; }
    .legend .item { display:flex; align-items:center; gap:8px; margin: 4px 0; }
    .swatch { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); }
    .muted { color:#666; }
    .hidden { display:none; }

    .leaflet-popup-content { margin: 10px 12px; }
    .popup-title { font-weight: 700; margin-bottom: 6px; }
    .popup-small { font-size: 12px; color: #555; margin-top: 6px; }
    .popup-btn {
      display:inline-block;
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="ctrlbox" id="howto">
  <h3>DJH-Karte (mobil)</h3>
  <p>Klicke eine <b>Jugendherberge</b> an: dann werden die <b>POIs</b> in der Umgebung <b>nachgeladen</b> (lazy).</p>
  <p class="muted">Tipp: POIs kannst du im Layer-Menü ein/ausblenden. Satellit ist optional.</p>
  <div class="row">
    <button class="btn" id="btnLegend">Legende</button>
    <button class="btn" id="btnHowto">How-to aus</button>
    <button class="btn" id="btnHome">Home</button>
  </div>
  <div class="status" id="status">Lade Jugendherbergen…</div>
</div>

<div class="legend hidden" id="legend">
  <h3>POI-Farben</h3>
  <div id="legendItems"></div>
  <div class="muted" style="margin-top:8px;">
    Farben folgen <code>category_group</code> im POI-GeoJSON.
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  // ---------- Config ----------
  const PATH_JH_ONLY = "data/jh_only.geojson";     // Jugendherbergen (Punkte)
  const PATH_POI = (nr) => `data/jh_${nr}.geojson`; // POIs pro JH (lazy)

  // Farben für category_group (anpassen wenn du willst)
  const COLOR_BY_GROUP = {
    "Bildungsinfrastruktur": "#1f77b4",
    "Kinder & Jugend": "#2ca02c",
    "Kultur & Geschichte": "#d62728",
    "Natur & Landschaft": "#9467bd",
    "Freizeit & Sport": "#ff7f0e",
    "Routen": "#8c564b",
    "Wissenschaft": "#17becf",
    "Information": "#7f7f7f",
    "POI": "#333333",
    "Unbekannt": "#333333"
  };

  // ---------- UI helpers ----------
  const elStatus = document.getElementById("status");
  const elLegend = document.getElementById("legend");
  const elLegendItems = document.getElementById("legendItems");
  const elHowto = document.getElementById("howto");

  function setStatus(msg) { elStatus.textContent = msg; }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function getNrFromProps(p) {
    const v = p?.nr ?? p?.Nr ?? p?.NR ?? p?.jh_nr ?? p?.JH_NR ?? null;
    if (v === null || v === undefined) return null;
    const m = String(v).match(/\d+/);
    return m ? m[0] : null;
  }

  function getNameFromProps(p) {
    return p?.name ?? p?.Name ?? p?.jh_name ?? p?.JH ?? p?.title ?? "Unbenannt";
  }

  function getOrtFromProps(p) {
    return p?.ort ?? p?.Ort ?? p?.city ?? p?.addr_city ?? "";
  }

  function getDescFromProps(p) {
    return p?.Description ?? p?.description ?? p?.desc ?? "";
  }

  function getGroupFromProps(p) {
    return p?.category_group ?? p?.categoryGroup ?? p?.group ?? p?.layer ?? "Unbekannt";
  }

  function colorForGroup(g) {
    return COLOR_BY_GROUP[g] || COLOR_BY_GROUP["Unbekannt"];
  }

  function buildLegend() {
    // nur die bekannten Gruppen zeigen (in definierter Reihenfolge)
    const order = [
      "Bildungsinfrastruktur","Kinder & Jugend","Kultur & Geschichte","Natur & Landschaft",
      "Freizeit & Sport","Routen","Wissenschaft","Information","Unbekannt"
    ];
    elLegendItems.innerHTML = "";
    for (const g of order) {
      const row = document.createElement("div");
      row.className = "item";
      const sw = document.createElement("div");
      sw.className = "swatch";
      sw.style.background = colorForGroup(g);
      const tx = document.createElement("div");
      tx.textContent = g;
      row.appendChild(sw);
      row.appendChild(tx);
      elLegendItems.appendChild(row);
    }
  }

  buildLegend();

  // ---------- Map + basemaps ----------
  const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, attribution: "&copy; OpenStreetMap"
  });

  // leichtgewichtiges Satellit-Overlay (ESRI World Imagery)
  const sat = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
    maxZoom: 19, attribution: "Tiles &copy; Esri"
  });

  const map = L.map("map", { layers: [osm] });

  // Layer containers
  const jhCluster = L.markerClusterGroup({
    chunkedLoading: true,
    showCoverageOnHover: false,
    spiderfyOnMaxZoom: true
  });

  const poiLayer = L.layerGroup();

  // Controls
  const baseLayers = { "OSM": osm, "Satellit": sat };
  const overlays = { "Jugendherbergen": jhCluster, "POIs (geladen)": poiLayer };

  L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

  // ---------- State ----------
  let homeBounds = null;
  const poiCache = new Map();  // nr -> GeoJSON (FeatureCollection)

  async function fetchJson(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status} für ${url}`);
    return await r.json();
  }

  // ---------- POI loader ----------
  async function loadPOIsForJH(nr) {
    if (!nr) throw new Error("Keine JH-Nr");
    if (poiCache.has(nr)) return poiCache.get(nr);

    const url = PATH_POI(nr);
    setStatus(`Lade POIs: JH ${nr} …`);
    const gj = await fetchJson(url);

    // Minimal-Sanity: FeatureCollection erwartet
    if (!gj || gj.type !== "FeatureCollection" || !Array.isArray(gj.features)) {
      throw new Error(`POI-GeoJSON hat unerwartetes Format: ${url}`);
    }

    poiCache.set(nr, gj);
    return gj;
  }

  function poiToLayer(feature, latlng) {
    const p = feature?.properties || {};
    const group = getGroupFromProps(p);

    return L.circleMarker(latlng, {
      radius: 6,
      color: colorForGroup(group),
      weight: 2,
      fillColor: colorForGroup(group),
      fillOpacity: 0.85
    });
  }

  function poiPopupHtml(p) {
    const name = escapeHtml(getNameFromProps(p));
    const group = escapeHtml(getGroupFromProps(p));
    const desc = getDescFromProps(p);

    return `
      <div class="popup-title">${name}</div>
      <div><b>Kategorie:</b> ${group}</div>
      ${desc ? `<div style="margin-top:6px">${desc}</div>` : `<div class="popup-small">Keine Zusatzinfos.</div>`}
    `;
  }

  // ---------- JH loading ----------
  async function init() {
    try {
      const gj = await fetchJson(PATH_JH_ONLY);

      // bounds
      const tmp = L.geoJSON(gj);
      homeBounds = tmp.getBounds();
      if (homeBounds && homeBounds.isValid()) map.fitBounds(homeBounds.pad(0.05));

      // markers
      const jhLayer = L.geoJSON(gj, {
        pointToLayer: (feature, latlng) => {
          return L.marker(latlng, { title: getNameFromProps(feature?.properties) });
        },
        onEachFeature: (feature, layer) => {
          const p = feature?.properties || {};
          const nr = getNrFromProps(p);
          const name = getNameFromProps(p);
          const ort = getOrtFromProps(p);

          const html = `
            <div class="popup-title">${escapeHtml(name)}</div>
            <div><b>Nr:</b> ${escapeHtml(nr ?? "—")}</div>
            ${ort ? `<div><b>Ort:</b> ${escapeHtml(ort)}</div>` : ""}
            <div class="popup-small">Klick lädt POIs (lazy).</div>
            <div>
              <button class="popup-btn" data-nr="${escapeHtml(nr ?? "")}">POIs laden</button>
            </div>
          `;

          layer.bindPopup(html);

          // 1) Klick auf Marker -> POIs laden
          layer.on("click", async () => {
            if (!nr) return;
            try {
              const gjPois = await loadPOIsForJH(nr);

              // ersetzen: immer nur die aktuell geladene JH anzeigen
              poiLayer.clearLayers();

              const poiGeo = L.geoJSON(gjPois, {
                pointToLayer: poiToLayer,
                onEachFeature: (f, l) => {
                  const pp = f?.properties || {};
                  l.bindPopup(poiPopupHtml(pp));
                },
                filter: (f) => {
                  // nur Punkte (alles andere ignorieren)
                  const t = f?.geometry?.type;
                  return t === "Point" || t === "MultiPoint";
                }
              });

              poiGeo.addTo(poiLayer);
              if (!map.hasLayer(poiLayer)) map.addLayer(poiLayer);

              setStatus(`POIs geladen: JH ${nr} (${gjPois.features.length} Features)`);
            } catch (e) {
              console.error(e);
              setStatus(`Fehler beim Laden der POIs für JH ${nr}: ${e.message}`);
              alert(`Konnte POIs für JH ${nr} nicht laden.\n${e.message}`);
            }
          });

          // 2) Button im Popup -> POIs laden (falls Klick irgendwo “verloren” geht)
          layer.on("popupopen", (ev) => {
            const btn = ev.popup.getElement()?.querySelector("button.popup-btn");
            if (!btn) return;
            btn.addEventListener("click", async () => {
              layer.fire("click");
            });
          });
        }
      });

      jhCluster.addLayer(jhLayer);
      map.addLayer(jhCluster);

      setStatus("Bereit. Klicke eine Jugendherberge an.");
    } catch (e) {
      console.error(e);
      setStatus(`Fehler: ${e.message}`);
      alert(`Konnte ${PATH_JH_ONLY} nicht laden.\n${e.message}`);
    }
  }

  // ---------- Buttons ----------
  document.getElementById("btnLegend").addEventListener("click", () => {
    elLegend.classList.toggle("hidden");
  });

  document.getElementById("btnHowto").addEventListener("click", (ev) => {
    const btn = ev.currentTarget;
    const hidden = elHowto.classList.toggle("hidden");
    btn.textContent = hidden ? "How-to an" : "How-to aus";
    // wenn Howto versteckt ist: Button ist weg – daher Buttontext nur relevant solange sichtbar
  });

  // “How-to aus” Button verschwindet beim Toggle; deshalb zusätzlich Keyboard Shortcut:
  document.addEventListener("keydown", (e) => {
    if (e.key.toLowerCase() === "h") elHowto.classList.toggle("hidden");
    if (e.key.toLowerCase() === "l") elLegend.classList.toggle("hidden");
  });

  document.getElementById("btnHome").addEventListener("click", () => {
    if (homeBounds && homeBounds.isValid()) map.fitBounds(homeBounds.pad(0.05));
  });

  // ---------- Go ----------
  init();
</script>
</body>
</html>
